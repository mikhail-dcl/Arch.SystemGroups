name: "PR - Build SourceGenerator DLL"

on:
  pull_request:
    paths-ignore:
      - '**/*.md'
      - '**/*.gitignore'
      - '**/*.gitattributes'

permissions:
  contents: read
  pull-requests: write

jobs:
  build-sourcegenerator:
    name: Build and Upload SourceGenerator DLL
    runs-on: ubuntu-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_NOLOGO: true

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          6.0.x
          7.0.x

    - name: Restore
      run: dotnet restore

    - name: Build SourceGenerator (Release)
      run: dotnet build Arch.SystemGroups.SourceGenerator/Arch.SystemGroups.SourceGenerator.csproj --configuration Release --no-restore

    - name: Create SourceGenerator Unity Package
      run: |
        PACKAGE_DIR="com.arch.systemgroups.sourcegenerator"
        PACKAGE_VERSION="1.0.0-pr.${{ github.event.pull_request.number }}.run${{ github.run_number }}"

        # Create package directory
        mkdir -p "$PACKAGE_DIR"

        # Copy SourceGenerator DLL
        cp Arch.SystemGroups.SourceGenerator/bin/Release/netstandard2.0/Arch.SystemGroups.SourceGenerator.dll "$PACKAGE_DIR/"

        # Create package.json
        cat > "$PACKAGE_DIR/package.json" << EOF
        {
          "name": "com.arch.systemgroups.sourcegenerator",
          "displayName": "Arch.SystemGroups SourceGenerator",
          "version": "$PACKAGE_VERSION",
          "unity": "2022.3",
          "description": "Source Generator for Arch.SystemGroups - generates boilerplate code for ECS systems",
          "keywords": ["unity", "ecs", "arch", "source-generator", "roslyn"],
          "homepage": "https://github.com/mikhail-dcl/Arch.SystemGroups",
          "bugs": {
            "url": "https://github.com/mikhail-dcl/Arch.SystemGroups/issues"
          },
          "repository": {
            "type": "git",
            "url": "git+ssh://git@github.com/mikhail-dcl/Arch.SystemGroups.git"
          },
          "license": "APACHE 2.0",
          "author": "mikhail-dcl (https://github.com/mikhail-dcl/)"
        }
        EOF

        # Create .meta file with RoslynAnalyzer configuration
        cat > "$PACKAGE_DIR/Arch.SystemGroups.SourceGenerator.dll.meta" << 'EOF'
        fileFormatVersion: 2
        guid: a1b2c3d4e5f6789012345678901234ab
        labels:
        - RoslynAnalyzer
        PluginImporter:
          externalObjects: {}
          serializedVersion: 2
          iconMap: {}
          executionOrder: {}
          isPreloaded: 0
          isOverridable: 0
          isExplicitlyReferenced: 0
          platformData:
          - first:
              Editor: Editor
            second:
              enabled: 1
              settings:
                CPU: AnyCPU
                DefaultValueInitialized: true
                OS: AnyOS
          - first:
              Any:
            second:
              enabled: 0
              settings: {}
          userData:
          assetBundleName:
          assetBundleVariant:
        EOF

        # Create tarball (UPM format)
        tar -czf "com.arch.systemgroups.sourcegenerator-$PACKAGE_VERSION.tgz" -C "$PACKAGE_DIR" .

        echo "âœ… Unity package created: com.arch.systemgroups.sourcegenerator-$PACKAGE_VERSION.tgz"
        echo "PACKAGE_VERSION=$PACKAGE_VERSION" >> $GITHUB_ENV
        echo "PACKAGE_FILE=com.arch.systemgroups.sourcegenerator-$PACKAGE_VERSION.tgz" >> $GITHUB_ENV

    - name: Upload SourceGenerator Unity Package
      uses: actions/upload-artifact@v4
      with:
        name: com.arch.systemgroups.sourcegenerator-PR${{ github.event.pull_request.number }}-run${{ github.run_number }}
        path: com.arch.systemgroups.sourcegenerator-*.tgz
        retention-days: 30

    - name: Comment on PR with artifact link
      uses: actions/github-script@v7
      with:
        script: |
          const packageName = `com.arch.systemgroups.sourcegenerator-PR${{ github.event.pull_request.number }}-run${{ github.run_number }}`;
          const packageVersion = `1.0.0-pr.${{ github.event.pull_request.number }}.run${{ github.run_number }}`;
          const runId = context.runId;
          const runNumber = '${{ github.run_number }}';
          const repo = context.repo;

          const comment = `## âœ… SourceGenerator Unity Package Built Successfully

          The SourceGenerator has been packaged as a Unity Package Manager (UPM) compatible package.

          **ðŸ“¦ Package:** \`com.arch.systemgroups.sourcegenerator\` v${packageVersion}

          ### ðŸ”— Download Package:
          [View Workflow Run and Download Artifact](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})

          ### ðŸ“¥ Installation in Unity:

          #### Option 1: Manual Installation (Tarball)
          1. Download the artifact from the link above (requires GitHub login)
          2. Extract the outer zip to get \`com.arch.systemgroups.sourcegenerator-${packageVersion}.tgz\`
          3. In Unity, go to **Window â†’ Package Manager**
          4. Click **+ â†’ Add package from tarball...**
          5. Select the downloaded \`.tgz\` file

          #### Option 2: Local Installation
          1. Extract the tarball to your Unity project's \`Packages/\` folder
          2. Unity will auto-detect and install the package

          ### ðŸ“‹ Package Contents:
          - **SourceGenerator DLL** with proper Unity meta configuration
          - Configured as **RoslynAnalyzer** for automatic code generation
          - Compatible with Unity 2022.3+

          ### â„¹ï¸ For Production Use:
          Use releases instead of PR artifacts for stable versions. PR packages are for testing only.

          **Build Details:**
          - Package: \`com.arch.systemgroups.sourcegenerator\`
          - Version: \`${packageVersion}\`
          - Configuration: Release
          - Target Framework: netstandard2.0
          - Workflow Run: [#${runId}](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})
          `;

          // Check if we already commented
          const { data: comments } = await github.rest.issues.listComments({
            owner: repo.owner,
            repo: repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('SourceGenerator Unity Package Built Successfully')
          );

          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: repo.owner,
              repo: repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }
