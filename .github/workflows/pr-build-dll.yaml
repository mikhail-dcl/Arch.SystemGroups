name: "PR - Build SourceGenerator DLL"

on:
  pull_request:
    paths-ignore:
      - '**/*.md'
      - '**/*.gitignore'
      - '**/*.gitattributes'

permissions:
  contents: read
  pull-requests: write

jobs:
  build-sourcegenerator:
    name: Build and Upload SourceGenerator DLL
    runs-on: ubuntu-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_NOLOGO: true

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          6.0.x
          7.0.x

    - name: Restore
      run: dotnet restore

    - name: Build SourceGenerator (Release)
      run: dotnet build Arch.SystemGroups.SourceGenerator/Arch.SystemGroups.SourceGenerator.csproj --configuration Release --no-restore

    - name: Prepare SourceGenerator DLL with Unity Meta
      run: |
        DLL_DIR="SourceGenerator-Artifact"
        mkdir -p "$DLL_DIR"

        # Copy DLL
        cp Arch.SystemGroups.SourceGenerator/bin/Release/netstandard2.0/Arch.SystemGroups.SourceGenerator.dll "$DLL_DIR/"

        # Create .meta file with RoslynAnalyzer configuration
        cat > "$DLL_DIR/Arch.SystemGroups.SourceGenerator.dll.meta" << 'EOF'
        fileFormatVersion: 2
        guid: a1b2c3d4e5f6789012345678901234ab
        labels:
        - RoslynAnalyzer
        PluginImporter:
          externalObjects: {}
          serializedVersion: 2
          iconMap: {}
          executionOrder: {}
          isPreloaded: 0
          isOverridable: 0
          isExplicitlyReferenced: 0
          platformData:
          - first:
              Editor: Editor
            second:
              enabled: 1
              settings:
                CPU: AnyCPU
                DefaultValueInitialized: true
                OS: AnyOS
          - first:
              Any:
            second:
              enabled: 0
              settings: {}
          userData:
          assetBundleName:
          assetBundleVariant:
        EOF

        echo "âœ… SourceGenerator DLL with Unity meta file prepared"

    - name: Upload SourceGenerator DLL
      uses: actions/upload-artifact@v4
      with:
        name: SourceGenerator-DLL-PR${{ github.event.pull_request.number }}-run${{ github.run_number }}
        path: SourceGenerator-Artifact/
        retention-days: 30

    - name: Comment on PR with artifact link
      uses: actions/github-script@v7
      with:
        script: |
          const artifactName = `SourceGenerator-DLL-PR${{ github.event.pull_request.number }}-run${{ github.run_number }}`;
          const runId = context.runId;
          const runNumber = '${{ github.run_number }}';
          const repo = context.repo;

          const comment = `## âœ… SourceGenerator DLL Built Successfully

          The SourceGenerator DLL has been built and is ready for testing in Unity.

          ### ðŸ”— Download:
          [View Workflow Run and Download Artifact](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})

          ### ðŸ“¥ Installation in Unity (Quick - One extraction):

          1. **Download** the artifact from the link above (requires GitHub login)
          2. **Extract once** - you'll get:
             - \`Arch.SystemGroups.SourceGenerator.dll\`
             - \`Arch.SystemGroups.SourceGenerator.dll.meta\` (configured as RoslynAnalyzer)
          3. **Copy both files** to your Unity project (e.g., \`Assets/Plugins/RoslynAnalyzers/\` or anywhere in Assets)
          4. Unity will automatically detect it as a Roslyn Analyzer and use it for code generation

          ### ðŸ“‹ What You Get:
          - âœ… SourceGenerator DLL (netstandard2.0)
          - âœ… Unity .meta file with RoslynAnalyzer label
          - âœ… Ready for immediate use in Unity 2022.3+

          ### â„¹ï¸ For Production Use:
          Use [releases](https://github.com/${repo.owner}/${repo.repo}/releases) instead of PR artifacts.
          Releases provide a complete UPM package (\`.tgz\`) that can be referenced via URL.

          **Build Details:**
          - Configuration: Release
          - Target Framework: netstandard2.0
          - PR: #${{ github.event.pull_request.number }}
          - Run: [#${runId}](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})
          `;

          // Check if we already commented
          const { data: comments } = await github.rest.issues.listComments({
            owner: repo.owner,
            repo: repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('SourceGenerator DLL Built Successfully')
          );

          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: repo.owner,
              repo: repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }
